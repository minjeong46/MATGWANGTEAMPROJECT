<html layout:decorate="~{layout}">
    <main layout:fragment="content">
        <!--상단-->
        <div style="background-color: #F4E9E3">
            <div class="container py-2">

                <!--수정해야할 부분-->
                <span class="" style="color: #555; font-family: 'HakgyoansimWoojuR'; padding-left: 8px">소근소근 > 한식루트 인증</span>

            </div>
        </div>
        <div class="container mt-5">
            <div class="text-center">
                <img th:src="@{/images/total/bab.png}" width="5%">
            </div>

            <!--수정해야할 부분-->
            <!--title-->
            <h2 class="text-center py-2 mj">한식루트 인증 등록</h2>
            <!--content-->
            <section class="py-5">

                <!--*** content 넣어야할 부분 (넣고 아래 div height 700px 준거 없애줘야 할거임) ***-->
                <div>

                    <!--제목, 주소검색-->
                    <form th:action="@{/root/register/form/save}" th:object="${rootDTO}" id="register-form" method="post" class="needs-validation" novalidate>
                        <div class="mb-2 row">
                            <label for="title" class="col-sm-1 col-form-label">제목</label>
                            <div class="col-sm-11">
                                <input type="text" id="title" name="title" th:field="*{title}" class="form-control" required>
                                <div class="invalid-feedback">
                                    제목을 입력해주세요.
                                </div>
                            </div>
                        </div>

                        <div class="mb-3 row">
                            <label for="query" class="col-sm-1 col-form-label">주소 검색</label>
                            <div class="col-sm-10">
                                <input type="text" id="query" name="query" th:value="${query}" class="form-control">
                            </div>
                            <div class="col-1 d-grid">
                                <button type="button" id="search-submit" class="btn btn-outline-primary">검색</button>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between h-100">

                            <!--left-->
                            <div class="d-flex flex-column justify-content-between" style="width: 60%;">
                                <!--top-->
                                <div id="map" style="width: 100%; min-height: 500px; flex-grow: 1;"></div>
                                <!--bottom-->
                                <div style="background-color: #E8DCD4; width: 100%;" class="py-2 ">
                                    <ul class="d-flex mb-0 flex-wrap" id="rootSelectList">
                                        <li></li>
                                    </ul>
                                </div>
                            </div>

                            <!--right-->
                            <div class="h-100" style="width: 35%;">
                                <ul th:if="${searchData}" style="background-color: #E8DCD4;" class="p-3 h-100 mb-0">
                                    <li id="search-data-list" th:each="searchData : ${searchData}" class="d-flex flex-row p-2 h-100" >
                                        <div class="my-2" style="width: 90%;">
                                            <h6 th:utext="${searchData.title}" style="font-weight: bold; cursor: pointer; " name="click-address"
                                                th:data-lat="${searchData.latitude}" th:data-lng="${searchData.longitude}"></h6>
                                            <p th:text="'카테고리: ' + ${searchData.category}" class="mb-2" style="font-size: 14px; color: #777"></p>
                                            <p th:text="'지번: ' + ${searchData.address}" class="mb-2" style="font-size: 14px; color: #444"></p>
                                            <p th:text="'도로명: ' + ${searchData.roadAddress}" class="mb-0" style="font-size: 14px; color: #444"></p>
                                            <input type="hidden" id="latitude" th:value = "${searchData.latitude}" />
                                            <input type="hidden"  id="longitude" th:value = "${searchData.longitude}"/>
                                        </div>
                                        <div class="d-flex justify-content-center align-items-center" style="width: 10%">
                                            <div class="checkbox-form">
                                                <input type="checkbox" name="checkbox" class="root-checkbox-input"
                                                       th:data-title="${searchData.title}"
                                                       th:data-address="${searchData.address}"
                                                       th:data-roadaddress="${searchData.roadAddress}"
                                                       th:data-latitude="${searchData.latitude}"
                                                       th:data-longitude="${searchData.longitude}"
                                                       th:data-link="${searchData.link}"
                                                       th:data-category="${searchData.category}"

                                                />
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <input type="hidden" id="form-mod" name="formMod" th:value="${rootSeq != null ? 'modify' : 'save'}">
                        <input type="hidden" id="rootListData" name="rootList">
                        <div class="d-flex justify-content-between mt-3">
                            <input type="button" id="map-button" class="btn btn-outline-secondary" value="루트 확인">
                            <input type="button" id="form-submit" name="form-submit" value="저장" class="btn btn-primary">
                            <input type="hidden" id="rootSeq" name="rootSeq" th:value="${rootSeq}">
                        </div>
                    </form>

                    <form id="searchForm" th:action="@{/root/register/form/search}" method="get">
                        <input type="hidden" id="hiddenQuery" name="query">
                    </form>

                </div>
            </section>
        </div>

        <script th:inline="javascript" layout:fragment="script">
            let locations = /*[[${searchData}]]*/ [];
            let map;
            let marker;
            let polyline;
            let rootList = /*[[${rootList}]]*/ [];


            // 페이지 로드 시 동작
            document.addEventListener("DOMContentLoaded", () => {
                checkboxState();

                let isModify = rootList && rootList.length > 0;

                const savedLat = sessionStorage.getItem("mapCenterLat");
                const savedLng = sessionStorage.getItem("mapCenterLng");

                let center;
                if (isModify) {
                    console.log("지금 여긴가?")

                    center = getCenter(rootList); // 수정 모드면 rootList 기준
                    console.log("흠" + center);
                }else if (savedLat && savedLng) {
                    center = new naver.maps.LatLng(parseFloat(savedLat), parseFloat(savedLng));
                    console.log("저장된 중심으로 맵 초기화", center);
                } else {
                    console.log("여긴 어디?")
                    center = new naver.maps.LatLng(37.5666805, 126.9784147); // 기본값
                }

                // 맵 초기화
                setMap(center);

                if (isModify) {
                    console.log("수정")
                    updateDrawPolyline(rootList);

                    sessionStorage.setItem("checkRoot", JSON.stringify(rootList));
                    updateSelectList();
                } else {
                    if (sessionStorage.getItem("savedCheckRoot")) {
                        console.log("작성")
                        sessionStorage.setItem("checkRoot", sessionStorage.getItem("savedCheckRoot"));
                        sessionStorage.removeItem("savedCheckRoot");  // 임시 저장한 데이터 제거
                        checkboxState();  // 체크박스 다시 적용
                        updateSelectList();  // 리스트 다시 업데이트
                        drawPolyline();  // 경로 다시 그리기
                    }
                }

                // 제목 유지
                const savedTitle = sessionStorage.getItem("savedTitle");
                if (savedTitle) {
                    document.getElementById("title").value = savedTitle;
                }
            });

            // 주소 검색 동작
            document.getElementById("search-submit").addEventListener("click", function () {
                const query = document.getElementById("query").value;

                // 검색 시 결과가 없을 경우
                if(query.length === 0) {
                    alert("검색 결과가 없습니다. 정확한 키워드를 입력해주세요.")
                }

                const center = map.getCenter();
                sessionStorage.setItem("mapCenterLat", center.lat());
                sessionStorage.setItem("mapCenterLng", center.lng());

                sessionStorage.setItem("savedCheckRoot", sessionStorage.getItem("checkRoot"));
                document.getElementById("hiddenQuery").value = query;
                document.getElementById("searchForm").submit();


            });

            // 검색 시 타이틀 초기화 방지
            document.getElementById("title").addEventListener("input", function () {
                sessionStorage.setItem("savedTitle", this.value);
            });


            // 맵 초기 설정
            function setMap(center) {

                console.log("동작")
                console.log("rootList", rootList)
                console.log("비교: " + center)
                map = new naver.maps.Map("map", {
                    center: center,
                    zoom: 16,
                    zoomControl: true,
                    mapTypeControl: true
                });

                if(rootList && rootList.length > 0){
                    const bounds = new naver.maps.LatLngBounds();
                    rootList.forEach(data => bounds.extend(new naver.maps.LatLng(data.latitude, data.longitude)));
                    map.fitBounds(bounds);
                }
            }

            // title 체크 시 지도/마커
            document.querySelectorAll('h6[name="click-address"]').forEach((data) => {
                data.addEventListener("click", function () {
                    const lat = parseFloat(data.dataset.lat);
                    const lng = parseFloat(data.dataset.lng);
                    const position = new naver.maps.LatLng(lat, lng);

                    map.setCenter(position);
                    map.setZoom(17);

                    if (marker) marker.setMap(null);

                    marker = new naver.maps.Marker({
                        position: position,
                        map: map,
                        icon: {
                            content: `<img width="20" height="20" src="https://img.icons8.com/material-outlined/24/map-pin.png" alt="map-pin" />`,
                            anchor: new naver.maps.Point(10, 40)
                        },
                        animation: naver.maps.Animation.BOUNCE
                    });


                });
            });

            // 체크박스 이벤트 처리
            document.querySelectorAll('input[name="checkbox"]').forEach((checkbox, index) => {
                checkbox.addEventListener("change", function () {
                    const obj = {
                        title: checkbox.dataset.title,
                        address: checkbox.dataset.address,
                        roadaddress: checkbox.dataset.roadaddress,
                        latitude: checkbox.dataset.latitude,
                        longitude: checkbox.dataset.longitude,
                        link: checkbox.dataset.link,
                        category: checkbox.dataset.category,
                    }
                    // console.log(typeof obj);
                    let sessionChkData = JSON.parse(sessionStorage.getItem("checkRoot")) || [];
                    // console.log(typeof sessionChkData);
                    if (this.checked) {
                        // some 하나라도
                        if (!sessionChkData.some(item => item.title === obj.title)) {
                            sessionChkData.push(obj);

                        }

                        map.setCenter(new naver.maps.LatLng(obj.latitude, obj.longitude))

                    } else {
                        // 체크되지 않았으면 지우기
                        sessionChkData = sessionChkData.filter(item => item.title !== obj.title);
                        // removeSelectStorage(obj);
                    }

                    sessionStorage.setItem("checkRoot", JSON.stringify(sessionChkData));
                    updateSelectList();
                    drawPolyline();


                });
            });

            // 체크박스 상태
            function checkboxState() {

                let sessionChkData = JSON.parse(sessionStorage.getItem("checkRoot")) || [];

                document.querySelectorAll('input[name="checkbox"]').forEach((checkbox) => {
                    checkbox.checked = sessionChkData.some(item => item.title === checkbox.dataset.title);
                });
            }


            // 리스트에 값 넣기
            function updateSelectList() {
                const rootSelectList = document.getElementById("rootSelectList");
                rootSelectList.innerHTML = "";
                const sessionChkData = JSON.parse(sessionStorage.getItem("checkRoot")) || [];

                if (sessionChkData.length === 0) {
                    rootSelectList.innerHTML = "<li> 위치를 추가하세요 </li>";
                    return;
                }

                sessionChkData.forEach((item) => {
                    const li = document.createElement("li");

                    const cleanTitle = item.title;
                    li.textContent = cleanTitle;
                    li.classList.add("root-list-style");

                    // 삭제 버튼 추가
                    const removeBtn = document.createElement("button");

                    const icon = document.createElement("i");
                    icon.classList.add("bi", "bi-x");

                    removeBtn.appendChild(icon);
                    removeBtn.classList.add("root-remove-btn-style");

                    removeBtn.addEventListener("click", (event) => {
                        event.stopPropagation(); // 부모 요소(li)의 클릭 이벤트 방지
                        removeSelectStorage(item);
                    });

                li.appendChild(removeBtn);

                li.dataset.title = item.title
                li.dataset.address = item.address
                li.dataset.roadaddress = item.roadaddress
                li.dataset.latitude = item.latitude
                li.dataset.longitude = item.longitude
                li.dataset.link = item.link
                li.dataset.category = item.category

                rootSelectList.appendChild(li);
            });
        }


            document.getElementById("rootSelectList").addEventListener("click", function (event) {

                // contains : 지정한 문자열 포함하는 요소 선택 / closest : 선택한 요소 포함하면서 가장 가까운 상위 요소 선택
                if (event.target.classList.contains("root-list-style") || event.target.closest(".root-list-style")) {
                    const ele = event.target.closest(".root-list-style");
                    const lat = parseFloat(ele.dataset.latitude);
                    const lng = parseFloat(ele.dataset.longitude);
                    const position = new naver.maps.LatLng(lat, lng);

                    // console.log(lat);
                    // console.log(lng);

                    map.setCenter(position);
                    map.setZoom(17);

                    if (marker) {
                        marker.setMap(null);
                    }
                    
                    // 체크 시 해당 좌표 마커
                    marker = new naver.maps.Marker({
                        position:position,
                        map: map,
                        icon: {
                            content: `<img width="20" height="20" src="https://img.icons8.com/material-outlined/24/map-pin.png" alt="map-pin" />`,
                            anchor: new naver.maps.Point(10, 40)
                        },
                        animation: naver.maps.Animation.BOUNCE
                    });


                }

            })


        // 로컬스토리지에서 값 삭제하는 함수
        function removeSelectStorage(value) {
            let sessionChkData = JSON.parse(sessionStorage.getItem("checkRoot")) || [];
            sessionChkData = sessionChkData.filter(item => item.title !== value.title);
            sessionStorage.setItem("checkRoot", JSON.stringify(sessionChkData));

            document.querySelectorAll('input[name="checkbox"]').forEach((chk)=>{
                if(chk.dataset.title === value.title) chk.checked = false;
            })
            updateSelectList();
            drawPolyline();
        }

        // 라인 그리기
        function drawPolyline() {
            const sessionChkData = JSON.parse(sessionStorage.getItem("checkRoot")) || [];

            const path = sessionChkData.map(data => new naver.maps.LatLng(data.latitude, data.longitude))

            if(polyline) polyline.setMap(null);

            polyline = new naver.maps.Polyline({
                map: map,
                path: path,
                strokeColor: '#FA5858',
                strokeStyle: 'stroke',
                strokeWeight: 2
            });

            if (window.markers) window.markers.forEach(marker => marker.setMap(null));
            window.markers = [];

            // 순서대로 마커 추가
            sessionChkData.forEach(data => {

                const marker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(data.latitude, data.longitude),
                    map: map,
                    icon: {
                        content: `<img width="30" height="30" src="https://img.icons8.com/stickers/30/standing-man-skin-type-1.png" alt="marker"/>`,
                        anchor: new naver.maps.Point(14, 20)
                    }
                });
                window.markers.push(marker);
            });
        }

            // 수정 -> 라인 그리기
            function updateDrawPolyline(line) {

                if (!line || line.length === 0) return;

                const path = line.map((data)=>{
                    console.log(data.latitude);
                    const lat = parseFloat(data.latitude);
                    const lng = parseFloat(data.longitude);
                    return new naver.maps.LatLng(lat, lng)
                })

                if(polyline) polyline.setMap(null);

                polyline = new naver.maps.Polyline({
                    map: map,
                    path: path,
                    strokeColor: '#FE2E2E',
                    strokeStyle: 'stroke',
                    strokeWeight: 2
                });

                addMarkers(line);
            }

            // 마커 추가
            function addMarkers(line) {
                if (window.markers) {
                    window.markers.forEach(marker => marker.setMap(null));
                }
                window.markers = [];

                // 순서대로 마커 추가
                line.forEach(data => {
                    const marker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(data.latitude, data.longitude),
                        map: map,
                        icon: {
                            content: `<img width="30" height="30" src="https://img.icons8.com/stickers/30/standing-man-skin-type-1.png" alt="marker"/>`,
                            anchor: new naver.maps.Point(14, 20)
                        }
                    });
                    window.markers.push(marker);
                });
            }

        // 루트 중앙 이동
        document.getElementById("map-button").addEventListener("click", function (){
            console.log("click")
            const sessionChkData = JSON.parse(sessionStorage.getItem("checkRoot")) || [];

            const path = sessionChkData.map((data)=>{
                console.log(data)
                return new naver.maps.LatLng(data.latitude, data.longitude)
            })

            // list 의 중앙값
            const center = getCenter(sessionChkData);

            // 중심 이동
            map.setCenter(center);

            // 경로에 맞게 줌 자동 조정
            const bounds = new naver.maps.LatLngBounds();
            path.forEach(coord => bounds.extend(coord));
            map.fitBounds(bounds);
        })

        // 중앙 값 구해서 설정
        function getCenter(value) {

            if (value == null) {
                return new naver.maps.LatLng(37.5666805, 126.9784147); // 기본 위치 (서울 시청)
            }

            let latSum = 0;
            let lngSum = 0;
            let cnt = value.length;

            value.forEach(data => {
                latSum += data.latitude;
                lngSum += data.longitude;
            });

            return new naver.maps.LatLng(latSum / cnt, lngSum / cnt);
        }

        // 저장
        document.getElementById("form-submit").addEventListener("click", function () {
            console.log("click");

            const saveForm = document.getElementById("register-form");

            let rootList = JSON.parse(sessionStorage.getItem("checkRoot")) || [];
            document.getElementById("rootListData").value = JSON.stringify(rootList);

            const formMode = document.getElementById("form-mod").value;
            const rootSeq = document.getElementById("rootSeq").value;


            if(!saveForm.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();

            }else {
                sessionStorage.removeItem("checkRoot");
                sessionStorage.removeItem("savedTitle")
                sessionStorage.removeItem("mapCenterLat");
                sessionStorage.removeItem("mapCenterLng");

                if (formMode === 'save') {
                    saveForm.action = "/root/register/form/save"; // 저장
                } else if (formMode === 'modify') {
                    alert("수정되었습니다.")
                    saveForm.action = `/root/register/form/modify/${rootSeq}`; // 수정
                }

                saveForm.submit();
            }
            saveForm.classList.add('was-validated');


        });

        // fetch 로 처리
        // document.getElementById("form-submit").addEventListener("click", function () {
        //     let title = document.getElementById("title").value;
        //     let rootList = JSON.parse(sessionStorage.getItem("checkRoot")) || [];
        //     console.log(rootList);
        //
        //     fetch("/root/register/form/save", {
        //         method: "POST",
        //         headers: {
        //             "Content-Type": "application/json",
        //             "Accept": "application/json"
        //         },
        //         body: JSON.stringify({
        //             title: title,
        //             rootList: rootList
        //         })
        //     })
        //         .then(response => response.json())
        //         .then(data => {
        //             console.log("성공fe", data);
        //             sessionStorage.removeItem("checkRoot");
        //             sessionStorage.removeItem("savedTitle")
        //
        //             window.location.href = "/root/register/save";
        //         })
        //         .catch(err => console.log("실패fe", err))
        //
        //
        // })

    </script>
    </main>
</html>