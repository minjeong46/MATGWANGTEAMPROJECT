<html layout:decorate="~{layout}">
<main layout:fragment="content">
    <!--상단-->
    <div style="background-color: #F4E9E3">
        <div class="container py-2">

            <!--수정해야할 부분-->
            <span class="" style="color: #555; font-family: 'HakgyoansimWoojuR'; padding-left: 8px">소근소근 > 한식루트 인증</span>

        </div>
    </div>
    <div class="container mt-5">
        <div class="text-center">
            <img th:src="@{/images/total/bab.png}" width="5%">
        </div>

        <!--수정해야할 부분-->
        <!--title-->
        <h2 class="text-center py-2">한식루트 보기</h2>
        <!--content-->
        <section class="py-5">

            <!--*** content 넣어야할 부분 (넣고 아래 div height 700px 준거 없애줘야 할거임) ***-->
            <div>
                <!-- **내용** -->
                <h3 th:text="${root.rootTitle}"></h3>
                <input type="hidden" id="select-value" th:value="${root.getRootSeq()}">
                <div class="card">
                    <div class="card-body">
                        <div id="map" style="width: 100%; min-height: 500px; flex-grow: 1;"></div>
                        <div style="background-color: #E8DCD4; width: 100%;" class="py-2 ">
                            <ul class="d-flex mb-0 flex-wrap" id="rootSelectList">
                                <li th:each="rootList : ${rootList}" th:text="${rootList.rootListIndex} + '. '
                                    + ${rootList.rootListTitle} + '&nbsp;&nbsp;' "></li>
                            </ul>
                        </div>
                        <div class="d-flex justify-content-end mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary me-2">수정</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary">삭제</button>
                        </div>

                    </div>

                </div>
            </div>
            <div class="d-flex justify-content-end mt-3">
                <input type="button" id="map-button" class="btn btn-outline-secondary me-2" value="루트 확인">


                <button type="button" class="btn btn-outline-secondary">
                    <a th:href="@{/root/register/list}" style="text-decoration: none; color: #6c757d">목록으로</a>
                </button>
            </div>
        </section>
    </div>

    <script th:inline="javascript" layout:fragment="script">
        let map;
        let marker;
        let polyline;

        let rootList = /*[[${root.rootList}]]*/ [];


        // 초기 map 설정
        function setMap() {
            map = new naver.maps.Map("map", {
                center: getCenter(rootList),
                zoom: 12, // 값이 클수록 확대
                zoomControl: true,
                mapTypeControl: true
            });

            naver.maps.Event.addListener(map, 'init', function() {
                if (rootList.length > 0) {
                    displayMap(rootList);
                    centerRootMove(rootList);
                }
            });
        }

        // 페이지 로드 시 동작
        document.addEventListener("DOMContentLoaded", ()=>{
            if (rootList.length > 0) {
                setMap();
            } else {
                setMap(37.5666805, 126.9784147);
            }

        });

        // map 에 표시
        function displayMap(rootList) {
            if (!rootList || rootList.length === 0) return;

            drawPolyline(rootList);
        }

        // 라인 그리기
        function drawPolyline(line) {

            if (!line || line.length === 0) return;

            const path = line.map((data)=>{
                // console.log(data)
                return new naver.maps.LatLng(data.rootListLatitude, data.rootListLongitude)
            })

            if(polyline) polyline.setMap(null);

            polyline = new naver.maps.Polyline({
                map: map,
                path: path,
                strokeColor: '#FE2E2E',
                strokeStyle: 'stroke',
                strokeWeight: 2
            });

            addMarkers(line);

        }

        // 마커 추가
        function addMarkers(line) {
            if (window.markers) {
                window.markers.forEach(marker => marker.setMap(null));
            }
            window.markers = [];

            // 순서대로 마커 추가
            line.forEach(data => {
                const marker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(data.rootListLatitude, data.rootListLongitude),
                    map: map,
                    icon: {
                        content: `<img width="30" height="30" src="https://img.icons8.com/stickers/30/standing-man-skin-type-1.png" alt="marker"/>`,
                        anchor: new naver.maps.Point(14, 20)
                    }
                });

                window.markers.push(marker);

            });
        }


        // root 중앙 이동
        function centerRootMove(root) {

            if (!root || root.length === 0) return;

            const path = root.map(data => new naver.maps.LatLng(data.rootListLatitude, data.rootListLongitude))

            // list 의 중앙값
            const center = getCenter(root);

            // 중심 이동
            map.setCenter(center);

            // 경로에 맞게 줌 자동 조정
            const bounds = new naver.maps.LatLngBounds();
            path.forEach(coord => bounds.extend(coord));
            map.fitBounds(bounds);
        }

        // 버튼 클릭 시 중앙 이동
        document.getElementById("map-button").addEventListener("click", function (){
            console.log("click");
            centerRootMove(rootList);
        })

        // 중앙 값 구해서 설정
        function getCenter(root) {

            if (!root || root.length === 0) return new naver.maps.LatLng(37.5666805, 126.9784147);

            let latSum = 0;
            let lngSum = 0;
            let cnt = root.length;

            root.forEach(data => {
                latSum += data.latitude;
                lngSum += data.longitude;
            });

            return new naver.maps.LatLng(latSum / cnt, lngSum / cnt);
        }



    </script>

</main>
</html>