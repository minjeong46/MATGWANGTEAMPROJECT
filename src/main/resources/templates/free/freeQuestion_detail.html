<html layout:decorate="~{layout}">
<main layout:fragment="content">
    <div class="d-flex justify-content-center align-items-center page-total-main-bg mb-5 shadow-sm">
        <h2 class="text-center text-white py-2 font-bold-style">자유게시판</h2>
    </div>
    <div class="container">

        <!-- 제목 -->
        <h2 class="border p-3 mb-3" style="font-size: 20px; background: #f9f9f9;">[[${freeQuestion.frboTitle}]]</h2>

        <!-- 본문 내용 -->
        <div class="border p-4 mb-4" style="min-height: 150px;">
            <div th:utext="${freeQuestion.frboContent}" style="font-size: 15px; line-height: 1.6;"></div>
        </div>

        <!-- 추천 버튼 & 추천 수 -->
        <div class="my-4 d-flex align-items-center gap-3" sec:authorize="isAuthenticated()">
            <a th:href="@{|/freequestion/recommend/${freeQuestion.frboSeq}|}"
               class="btn d-flex align-items-center"
               style="padding: 8px 16px; border-radius: 30px;"
               th:classappend="${#lists.contains(freeQuestion.freeCnt, #authentication.principal)} ? 'btn-danger' : 'btn-primary'">
                <!-- 하트 아이콘 -->
                <i class="bi" th:classappend="${#lists.contains(freeQuestion.freeCnt, #authentication.principal)} ? 'bi-heart-fill me-2' : 'bi-heart me-2'"></i>
                <span th:text="${#lists.contains(freeQuestion.freeCnt, #authentication.principal)} ? '추천 취소' : '추천하기'"></span>
            </a>
            <!-- 추천 수 -->
            <span class="ms-2" style="font-size: 16px;">
        <i class="bi bi-hand-thumbs-up-fill"></i>
        <b th:text="${freeQuestion.freeCnt.size()}">0</b> 명이 추천했어요
    </span>
        </div>

        <!-- 수정/삭제 버튼 -->
        <div class="text-end mb-4" sec:authorize="isAuthenticated()">
            <a th:href="@{|/freequestion/modify/${freeQuestion.frboSeq}|}" class="btn btn-outline-secondary btn-sm">수정</a>
            <a href="javascript:void(0);" th:data-uri="@{|/freequestion/delete/${freeQuestion.frboSeq}|}" class="delete btn btn-outline-danger btn-sm">삭제</a>
        </div>

        <!-- 댓글 작성 -->
        <div class="border p-3 mb-4" sec:authorize="isAuthenticated()">
            <h6 class="fw-bold">댓글 작성</h6>
            <form th:action="@{|/freeanswer/create/${freeQuestion.frboSeq}|}" method="post">
                <textarea name="frboAnsContent" rows="3" class="form-control mb-2" placeholder="댓글을 입력하세요."></textarea>
                <div class="text-end">
                    <button type="submit" class="btn btn-dark btn-sm">등록</button>
                </div>
            </form>
        </div>

        <!-- 댓글 목록 -->
        <div class="border">
            <h6 class="p-3 border-bottom mb-0 fw-bold">댓글 목록</h6>
            <ul class="list-group list-group-flush">
                <!-- 댓글 루프 -->
                <li th:each="answer : ${freeQuestion.answerList}" class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div th:id="'answerContent-' + ${answer.frboAnSeq}" th:utext="${answer.frboAnsContent}" style="font-size: 14px;"></div>
                        <small class="text-muted" th:text="${#temporals.format(answer.frboARegDate, 'yyyy-MM-dd HH:mm')}"></small>
                    </div>
                    <div class="mt-2 d-flex gap-2" sec:authorize="isAuthenticated()">
                        <button class="btn btn-sm btn-outline-secondary" th:onclick="|showEditForm(${answer.frboAnSeq})|">수정</button>
                        <form th:id="'editForm-' + ${answer.frboAnSeq}" th:action="@{|/freeanswer/modify/${answer.frboAnSeq}|}" method="post" style="display: none;" class="w-100 mt-2">
                            <textarea class="form-control mb-2" name="frboAnsContent" th:text="${answer.frboAnsContent}" rows="2"></textarea>
                            <button class="btn btn-sm btn-dark">수정 완료</button>
                        </form>
                        <form th:action="@{|/freeanswer/delete/${answer.frboAnSeq}|}" method="post">
                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('댓글을 삭제하시겠습니까?');">삭제</button>
                        </form>
                        <button class="btn btn-sm btn-outline-primary" th:onclick="|toggleReplyForm(${answer.frboAnSeq})|">대댓글</button>
                    </div>

                    <!-- 대댓글 입력폼 -->
                    <form th:id="'replyForm-' + ${answer.frboAnSeq}" th:action="@{|/freeanswer/reply/${answer.frboAnSeq}|}" method="post" class="mt-2" style="display: none;">
                        <textarea class="form-control mb-2" name="frboAnsContent" rows="2" placeholder="대댓글 입력..."></textarea>
                        <button class="btn btn-sm btn-dark">등록</button>
                    </form>

                    <!-- 대댓글 목록 -->
                    <ul class="list-group mt-3 ms-3">
                        <li th:each="childAnswer : ${answer.childAnswers}" class="list-group-item p-2 border">
                            <div th:utext="${childAnswer.frboAnsContent}" style="font-size: 13px;"></div>
                            <small class="text-muted" th:text="${#temporals.format(childAnswer.frboARegDate, 'yyyy-MM-dd HH:mm')}"></small>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>

    </div>

    <!-- JavaScript (동일) -->
    <script>
        function showEditForm(answerId) {
            const editForm = document.getElementById('editForm-' + answerId);
            const answerContent = document.getElementById('answerContent-' + answerId);
            if (editForm.style.display === "none") {
                editForm.style.display = "block";
                answerContent.style.display = "none";
            } else {
                editForm.style.display = "none";
                answerContent.style.display = "block";
            }
        }

        function toggleReplyForm(answerId) {
            var form = document.getElementById('replyForm-' + answerId);
            form.style.display = (form.style.display === 'none') ? 'block' : 'none';
        }
    </script>

</main>
</html>
