<!DOCTYPE html>
<html layout:decorate="~{layout}">
<main layout:fragment="content">

    <!-- 상단 -->
    <div style="background-color: #F4E9E3">
        <div class="container py-2">
            <link rel="stylesheet" type="text/css" th:href="@{/mj.css}">
            <span style="color: #555; font-family: 'HakgyoansimWoojuR'; padding-left: 8px">한끝 커뮤니티 > 맛집소개</span>
        </div>
    </div>

    <div class="container mt-5">
        <!-- 제목 -->
        <div class="text-center">
            <img th:src="@{/images/total/밥그릇.png}" width="5%">
        </div>
        <h2 class="text-center py-2">맛집소개</h2>

        <!-- 본문 카드 -->
        <section class="py-5">
            <div class="shadow-sm p-4" style="border-radius: 16px; background-color: #FFFFFF;">
                <h3 th:text="${mjboard.mjTitle}" style="font-weight: bold; font-size: 24px;"></h3>
                <div class="mt-3" style="white-space: pre-line;" th:utext="${mjboard.mjContent}"></div>
                <div class="d-flex justify-content-between mt-3 text-muted" style="font-size: 13px;">
                    <span th:text="${#temporals.format(mjboard.mjRegDate, 'yyyy-MM-dd HH:mm')}"></span>
                    <span>조회수 : <span th:text="${mjboard.mjCnt}"></span></span>
                </div>
            </div>

            <!-- 추천 버튼 (크기 축소) -->
            <div class="like-buttonmj mt-3 d-inline-flex align-items-center" th:data-uri="@{/mjboard/mjRecommend/{id}(id=${mjboard.mjSeq})}">
                <input class="on d-none" id="heart" type="checkbox" th:checked="${isRecommended}" />
                <label class="likemj d-inline-flex align-items-center px-2 py-1 border rounded" for="heart" style="cursor: pointer; font-size: 13px;">
                    ❤️ <span class="like-textmj ms-1">추천</span>
                </label>
                <span class="badge bg-secondary ms-2" id="recommendCount" th:text="${#lists.size(mjboard.recommendUsers)}"></span>
            </div>

            <!-- 수정/삭제 버튼 -->
            <div th:if="${#authentication.name == mjboard.userId.username}" class="mt-3">
                <a th:href="@{|/mjboard/modify/${mjboard.mjSeq}|}" class="btn btn-outline-secondary btn-sm rounded-pill">수정</a>
                <a href="javascript:void(0);" th:data-uri="@{|/mjboard/delete/${mjboard.mjSeq}|}" class="delete btn btn-outline-danger btn-sm rounded-pill">삭제</a>
            </div>

            <!-- 댓글 수 -->
            <h6 class="mt-4 border-bottom pb-2" th:text="|${#lists.size(mjboard.mjAanswerList)}개의 댓글이 있습니다.|" style="font-weight: bold;"></h6>

            <!-- 댓글 반복 -->
            <div th:each="mjanswer : ${mjboard.mjAanswerList}" th:if="${mjanswer.mjAnsComment == null}" class="my-2">
                <div style="font-size: 14px; font-weight: bold;">
                    <span th:text="${mjanswer.userId != null ? mjanswer.userId.nickname : '알 수 없음'}"></span>:
                    <span th:text="${mjanswer.mjAnsContent}"></span>
                </div>
                <div style="font-size: 12px; color: gray;" th:text="${#temporals.format(mjanswer.mjAnsRegDate, 'yyyy-MM-dd HH:mm')}"></div>

                <!-- 대댓글 반복 -->
                <div th:each="child : ${mjanswer.childAnswers}" class="ms-4 border-start ps-3 mt-2" style="border-left: 2px solid #ddd;">
                    <div style="font-size: 13px;">
                        ㄴ <b th:text="${child.userId != null ? child.userId.nickname : '알 수 없음'}"></b>
                        <span th:text="${child.mjAnsContent}"></span>
                    </div>
                    <div style="font-size: 11px; color: gray;" th:text="${#temporals.format(child.mjAnsRegDate, 'yyyy-MM-dd HH:mm')}"></div>
                </div>

                <!-- 대댓글 작성 -->
                <form th:action="@{|/mjanswer/reply/${mjanswer.mjAnsSeq}|}" method="post" th:object="${mjreplyForm}" class="mt-2 ms-4">
                    <textarea class="form-control form-control-sm" name="mjAnsContent" rows="1" placeholder="대댓글 작성..." style="font-size: 13px;"></textarea>
                    <button type="submit" class="btn btn-sm btn-outline-primary mt-1">등록</button>
                </form>
            </div>

            <!-- 댓글 작성 -->
            <form th:action="@{|/mjanswer/create/${mjboard.mjSeq}|}" method="post" th:object="${mjanswerForm}" class="mt-4">
                <textarea class="form-control" name="mjAnsContent" rows="2" placeholder="댓글을 작성해주세요" style="font-size: 14px;"></textarea>
                <button type="submit" class="btn btn-outline-primary mt-2">댓글 등록</button>
            </form>

            <!-- 맛집 목록 이동 버튼 추가 -->
            <div class="text-center mt-4">
                <a th:href="@{/mjboard/list}" class="btn btn-outline-dark btn-sm">맛집 목록으로 이동</a>
            </div>

            <hr style="margin-top: 50px">

            <!-- ✅ 스크립트 -->
            <script layout:fragment="script" type="text/javascript">
                // 삭제 스크립트
                document.querySelectorAll(".delete").forEach(function (element) {
                    element.addEventListener('click', function () {
                        if (confirm("정말로 삭제하시겠습니까?")) {
                            location.href = this.dataset.uri;
                        }
                    });
                });

                // 추천 스크립트
                document.addEventListener('DOMContentLoaded', function () {
                    const recommendElement = document.querySelector('.like-buttonmj');
                    recommendElement.addEventListener("click", function () {
                        const url = this.dataset.uri;
                        fetch(url, { method: "POST" })
                            .then(response => {
                                if (!response.ok) {
                                    alert("로그인이 필요합니다.");
                                    window.location.href = "/users/login";
                                    return;
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data) {
                                    document.querySelector('#recommendCount').textContent = data.count;
                                }
                            })
                            .catch(error => console.error("추천 에러 발생:", error));
                    });
                });
            </script>

</main>
</html>
